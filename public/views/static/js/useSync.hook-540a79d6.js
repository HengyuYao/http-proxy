var G=Object.defineProperty,x=Object.defineProperties;var H=Object.getOwnPropertyDescriptors;var O=Object.getOwnPropertySymbols;var J=Object.prototype.hasOwnProperty,K=Object.prototype.propertyIsEnumerable;var F=(t,e,n)=>e in t?G(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,U=(t,e)=>{for(var n in e||(e={}))J.call(e,n)&&F(t,n,e[n]);if(O)for(var n of O(e))K.call(e,n)&&F(t,n,e[n]);return t},A=(t,e)=>x(t,H(e));var h=(t,e,n)=>new Promise((s,T)=>{var y=c=>{try{p(n.next(c))}catch(o){T(o)}},L=c=>{try{p(n.throw(c))}catch(o){T(o)}},p=c=>c.done?s(c.value):Promise.resolve(c.value).then(y,L);p((n=n.apply(t,e)).next())});import{k as j,ax as b,aN as g,aY as E,cB as q,cC as Q,R as P,aL as Y,M as N,aM as z,ab as W,cD as X,a6 as Z,cu as R}from"./index-5531d778.js";import{u as tt,a as et,P as l,g as u,C as w,h as at,B as I,f as V}from"./chartEditStore-525fc79f.js";import{u as ot,C as B}from"./chartLayoutStore-6a0b58af.js";import{f as nt,d as rt,e as it}from"./index-1690038a.js";import{b as st,u as D,s as dt,f as ft}from"./project.api-0de940dc.js";const ct=t=>t,St=(t,e)=>{try{if(e.id){const n="vnodeBeforeMount"in e.events,s="vnodeMounted"in e.events;return n&&(t.events.advancedEvents.vnodeBeforeMount=e==null?void 0:e.events.vnodeBeforeMount),s&&(t.events.advancedEvents.vnodeMounted=e==null?void 0:e.events.vnodeMounted),(n||s)&&(e.events={baseEvent:{[I.ON_CLICK]:void 0,[I.ON_DBL_CLICK]:void 0,[I.ON_MOUSE_ENTER]:void 0,[I.ON_MOUSE_LEAVE]:void 0},advancedEvents:{[V.VNODE_MOUNTED]:void 0,[V.VNODE_BEFORE_MOUNT]:void 0},interactEvents:[]}),t}}catch(n){return t}},m=(t,e,n=!1)=>{if(St(t,e),n)return R(t,e);const s=e.option;if(!s)return R(t,e);if(e.option=void 0,s)return A(U({},R(t,e)),{option:s})},vt=()=>{const t=tt(),e=et(),n=j(),s=ot(),T=(o,S=!1,f=!1)=>h(void 0,null,function*(){S&&(t.componentList=[],e.clearBackStack(),e.clearForwardStack()),o.editCanvasConfig=ct(o.editCanvasConfig),o.componentList.forEach(a=>h(void 0,null,function*(){const i=r=>{window.$vue.component(r.chartConfig.chartKey)||(window.$vue.component(r.chartConfig.chartKey,nt(r.chartConfig)),window.$vue.component(r.chartConfig.conKey,rt(r.chartConfig)))};a.isGroup?a.groupList.forEach(r=>{i(r)}):i(a)}));const C=(a,i)=>h(void 0,null,function*(){let r=yield it(a.chartConfig);a.chartConfig.redirectComponent&&(a.chartConfig.dataset&&(r.option.dataset=a.chartConfig.dataset),r.chartConfig.title=a.chartConfig.title,r.chartConfig.chartFrame=a.chartConfig.chartFrame),i?i(f?m(r,A(U({},a),{id:N()})):m(r,a)):f?t.addComponentList(m(r,A(U({},a),{id:N()})),!1,!0):t.addComponentList(m(r,a),!1,!0)});for(const a in o)if(a===w.COMPONENT_LIST){let i=0;const r=o[a].length;for(const d of o[a]){let M=parseInt((parseFloat(`${++i/r}`)*100).toString());if(s.setItemUnHandle(B.PERCENTAGE,M),d.isGroup){let v=new at;f?v=m(v,A(U({},d),{id:N()})):v=m(v,d);const _=[];for(const $ of d.groupList)yield C($,k=>{_.push(k)});v.groupList=_,t.addComponentList(v,!1,!0)}else yield C(d);M===100&&(e.clearBackStack(),e.clearForwardStack())}}else(a===w.EDIT_CANVAS_CONFIG||a===w.REQUEST_GLOBAL_CONFIG)&&m(t[a],o[a],!0);s.setItemUnHandle(B.PERCENTAGE,0)}),y=o=>{const{id:S,projectName:f,remarks:C,indexImage:a,state:i}=o;t.setProjectInfo(l.PROJECT_ID,S),t.setProjectInfo(l.PROJECT_NAME,f),t.setProjectInfo(l.REMARKS,C),t.setProjectInfo(l.THUMBNAIL,a),t.setProjectInfo(l.RELEASE,i===1)},L=()=>h(void 0,null,function*(){t.componentList=[],t.setEditCanvas(u.SAVE_STATUS,E.START);try{const o=yield ft({projectId:g()});if(o&&o.code===P.SUCCESS){if(o.data){y(o.data),yield T(z(o.data.content));return}else t.setProjectInfo(l.PROJECT_ID,g());setTimeout(()=>{t.setEditCanvas(u.SAVE_STATUS,E.SUCCESS)},1e3);return}t.setEditCanvas(u.SAVE_STATUS,E.FAILURE)}catch(o){t.setEditCanvas(u.SAVE_STATUS,E.FAILURE),W()}}),p=b((o=!0)=>h(void 0,null,function*(){if(!g())return;let S=t.getProjectInfo[l.PROJECT_ID];if(S===null||S===""){window.$message.error("数据初未始化成功,请刷新页面！");return}t.setEditCanvas(u.SAVE_STATUS,E.START);try{if(o){const a=document.querySelector(".go-edit-range"),i=yield q(a,{backgroundColor:null,allowTaint:!0,useCORS:!0});let r=new FormData;r.append("object",Q(i.toDataURL(),`${g()}_index_preview.png`));const d=yield st(r);d&&d.code===P.SUCCESS&&(d.data.fileurl?yield D({id:g(),indexImage:`${d.data.fileurl}`}):yield D({id:g(),indexImage:`${n.getFetchInfo.OSSUrl}${d.data.fileName}`}))}}catch(a){console.log(a)}let f=new FormData;f.append("projectId",S),f.append("content",Y(t.getStorageInfo()||{}));const C=yield dt(f);if(C&&C.code===P.SUCCESS){setTimeout(()=>{t.setEditCanvas(u.SAVE_STATUS,E.SUCCESS)},1e3);return}t.setEditCanvas(u.SAVE_STATUS,E.FAILURE)}),3e3);return{updateComponent:T,updateStoreInfo:y,dataSyncFetch:L,dataSyncUpdate:p,intervalDataSyncUpdate:()=>{const o=setInterval(()=>{p()},X*1e3);Z(()=>{clearInterval(o)})}}};export{vt as u};
